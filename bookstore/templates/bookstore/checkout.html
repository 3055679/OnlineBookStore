{% extends 'bookstore/base.html' %} {% block body %}
<div class="container mt-4">
  <div class="row">
    <!-- Shipping Address & Payment Section -->
    <div class="col-md-8">
      <h4>Shipping Address</h4>
      <form id="checkout-form">
        {% for book in cart_books %}
            <input type="hidden" name="book_id[]" value="{{ book.id }}">
        {% endfor %}


        <div class="row">
          <div class="col-md-6">
            <label>Name*</label>
            <input type="text" class="form-control" name="name" required />
          </div>
          <div class="col-md-6">
            <label>Email*</label>
            <input
              type="email"
              class="form-control"
              name="email"
              value="abc@gmail.com"
              required
            />
          </div>
        </div>

        <div class="mt-3">
          <label>Phone</label>
          <input type="text" class="form-control" name="phone" />
        </div>

        <div class="mt-3">
          <label>Address</label>
          <input
            type="text"
            class="form-control"
            name="address"
            placeholder="Flat"
          />
        </div>

        <div class="row mt-3">
          <div class="col-md-4">
            <label>Division</label>
            <input type="text" class="form-control" name="division" />
          </div>
          <div class="col-md-4">
            <label>State</label>
            <input type="text" class="form-control" name="state" />
          </div>
          <div class="col-md-4">
            <label>Zipcode</label>
            <input type="text" class="form-control" name="zipcode" />
          </div>
        </div>

        <!-- Payment Method -->
        <h4 class="mt-4">Payment Method*</h4>
        <div class="mt-2">
          <input type="radio" name="payment" value="credit" required /> Credit
          Card
          <input type="radio" name="payment" value="debit" class="ms-3" /> Debit
          Card
          <input type="radio" name="payment" value="paypal" class="ms-3" />
          PayPal
        </div>

        <!-- Credit/Debit Card Fields -->
        <div id="card-fields" class="mt-3" style="display: none">
          <label>Account No*</label>
          <input type="text" class="form-control" name="account_no" />

          <div class="row mt-3">
            <div class="col-md-4">
              <label>CVV*</label>
              <input type="text" class="form-control" name="cvv" />
            </div>
            <div class="col-md-4">
              <label>Expiry Date*</label>
              <input
                type="text"
                class="form-control"
                name="expiry_date"
                placeholder="MM/YY"
              />
            </div>
            <div class="col-md-4">
              <label>Sort Code*</label>
              <input type="text" class="form-control" name="sort_code" />
            </div>
          </div>
        </div>

        <!-- PayPal Fields -->
        <div id="paypal-fields" class="mt-3" style="display: none">
          <label>PayPal ID*</label>
          <input type="email" class="form-control" name="paypal_id" />
        </div>

        <!-- Continue to Checkout -->
        <button type="submit" class="btn btn-primary w-100 mt-4">
          Continue to Checkout
        </button>
      </form>
    </div>

    <!-- Checkout Summary -->
    <div class="col-md-4">
      <h4>Checkout Summary</h4>
      <table class="table">
        <tr>
          <td>Books</td>
          <td id="total-items">{{ total_items }}</td>
        </tr>
        <tr>
          <td>Subtotal</td>
          <td id="subtotal">$ {{ subtotal }}</td>
        </tr>
        <tr>
          <td>Shipping</td>
          <td id="shipping">$ {{ shipping }}</td>
        </tr>
        <tr>
          <td><b>Payable Total</b></td>
          <td>
            <b id="total_price">$ {{ total }}</b>
            <input type="hidden" id="total_price_input" name="total_price" value="{{ total }}">
          </td>
        </tr>        
      </table>
    </div>
  </div>
</div>

<!-- <script>
  // Show relevant payment fields based on the selected payment method
  document.querySelectorAll('input[name="payment"]').forEach((input) => {
    input.addEventListener("change", function () {
      let paymentMethod = this.value;
      document.getElementById("card-fields").style.display =
        paymentMethod === "credit" || paymentMethod === "debit"
          ? "block"
          : "none";
      document.getElementById("paypal-fields").style.display =
        paymentMethod === "paypal" ? "block" : "none";
    });
  });

  // Submit the form via AJAX
  document
    .getElementById("checkout-form")
    .addEventListener("submit", function (event) {
      event.preventDefault();

      let formData = {
        name: document.querySelector('input[name="name"]').value,
        email: document.querySelector('input[name="email"]').value,
        phone: document.querySelector('input[name="phone"]').value,
        address: document.querySelector('input[name="address"]').value,
        division: document.querySelector('input[name="division"]').value,
        state: document.querySelector('input[name="state"]').value,
        zipcode: document.querySelector('input[name="zipcode"]').value,
        payment_method: document.querySelector('input[name="payment"]:checked')
          .value,
        account_no:
          document.querySelector('input[name="account_no"]')?.value || "",
        cvv: document.querySelector('input[name="cvv"]')?.value || "",
        expiry_date:
          document.querySelector('input[name="expiry_date"]')?.value || "",
        sort_code:
          document.querySelector('input[name="sort_code"]')?.value || "",
        paypal_id:
          document.querySelector('input[name="paypal_id"]')?.value || "",
        total_price: parseFloat(localStorage.getItem("subtotal")) + 5,
      };

      fetch("{% url 'bookstore:place_order' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}",
        },
        body: JSON.stringify(formData),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            localStorage.setItem("order_id", data.order_id);
            window.location.href = "{% url 'bookstore:transaction' %}";
          } else {
            alert("Order failed. Please try again.");
          }
        });
    });
</script> -->


<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Show relevant payment fields based on the selected payment method
    document.querySelectorAll('input[name="payment"]').forEach((input) => {
      input.addEventListener("change", function () {
        let paymentMethod = this.value;
        document.getElementById("card-fields").style.display =
          paymentMethod === "credit" || paymentMethod === "debit"
            ? "block"
            : "none";
        document.getElementById("paypal-fields").style.display =
          paymentMethod === "paypal" ? "block" : "none";
      });
    });

    let placeOrderUrl = "{% url 'bookstore:place_order' %}"; 


    // Submit the form via AJAX
    document
      .getElementById("checkout-form")
      .addEventListener("submit", function (event) {
        event.preventDefault();

        let totalPriceElement = document.getElementById("total_price_input");
        let totalPrice = 0;
        if (totalPriceElement) {
          totalPrice = parseFloat(totalPriceElement.textContent.replace("$", "").trim());
        } else {
          alert("Error: Total price not found.");
          return;
        }

        // Gather form data
        let formData = {
          name: document.querySelector('input[name="name"]').value,
          email: document.querySelector('input[name="email"]').value,
          phone: document.querySelector('input[name="phone"]').value,
          address: document.querySelector('input[name="address"]').value,
          division: document.querySelector('input[name="division"]').value,
          state: document.querySelector('input[name="state"]').value,
          zipcode: document.querySelector('input[name="zipcode"]').value,

          payment_method: document.querySelector(
            'input[name="payment"]:checked'
          ).value,
          account_no:
            document.querySelector('input[name="account_no"]')?.value || "",
          cvv: document.querySelector('input[name="cvv"]')?.value || "",
          expiry_date:
            document.querySelector('input[name="expiry_date"]')?.value || "",
          sort_code:
            document.querySelector('input[name="sort_code"]')?.value || "",
          paypal_id:
            document.querySelector('input[name="paypal_id"]')?.value || "",
          total_price: totalPrice, 
          book_ids:bookIds,
         
        };

        // Debugging: Print the form data
        console.log("ðŸŸ¢ Form Data:", formData);

        // Send the form data to the server
        fetch(placeOrderUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}",
          },
          body: JSON.stringify(formData),
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("ðŸŸ¢ Server Response:", data);
            if (data.success) {
              localStorage.setItem("order_id", data.order_id);
              window.location.href = "{% url 'bookstore:transaction' %}";
            } else {
              alert(
                "Order failed. Please try again. Error: " +
                  (data.error || "Unknown error")
              );
            }
          })
          .catch((error) => {
            console.error("ðŸ”´ Fetch Error:", error);
            alert("An error occurred. Please try again.");
          });
      });
  });
</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    let cart = JSON.parse(localStorage.getItem("cart")) || {}; 
    console.log("ðŸŸ¢ Cart details:", cart);

    if (Object.keys(cart).length === 0) {
        alert("âš ï¸ The cart is emptyï¼");
        window.location.href = "{% url 'bookstore:cart' %}";
        return;
    }

    function updateCheckoutSummary() {
        let totalItems = Object.values(cart).reduce((sum, qty) => sum + qty, 0);
        let subtotal = 0;
        let shipping = 5.00;

        fetch("{% url 'bookstore:get_cart_summary' %}", { method: "GET" })
        .then(response => response.json())
        .then(data => {
            subtotal = data.subtotal;
            document.getElementById("total-items").textContent = totalItems;
            document.getElementById("subtotal").textContent = `$ ${subtotal.toFixed(2)}`;
            document.getElementById("shipping").textContent = `$ ${shipping.toFixed(2)}`;
            document.getElementById("total_price").textContent = `$ ${(subtotal + 5).toFixed(2)}`;
        })
        .catch(error => console.error("ðŸ”´ Error fetching cart summary:", error));
    }

    updateCheckoutSummary(); // update Checkout Summary 

    
    document.getElementById("checkout-form").addEventListener("submit", function (event) {
        event.preventDefault(); 

        let formData = {
            name: document.querySelector('input[name="name"]').value,
            email: document.querySelector('input[name="email"]').value,
            phone: document.querySelector('input[name="phone"]').value,
            address: document.querySelector('input[name="address"]').value,
            payment_method: document.querySelector('input[name="payment"]:checked')?.value || "",
            cart: cart // 
        };

        console.log("ðŸŸ¢ Sent order data:", formData);

        fetch("{% url 'bookstore:place_order' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}",
            },
            body: JSON.stringify(formData),
        })
        .then(response => response.json())
        .then(data => {
            console.log("ðŸŸ¢ Server Response:", data);
            if (data.success) {
                alert("âœ… Order created successfully!");
                localStorage.removeItem("cart"); // 
                window.location.href = "{% url 'bookstore:transaction' %}?order_id=" + data.order_id;
            } else {
                alert("âš ï¸ Order failedï¼š" + (data.error || "Unknown Error."));
            }
        })
        .catch(error => console.error("ðŸ”´ Order error:", error));
    });
});

</script>
  

{% endblock %}
